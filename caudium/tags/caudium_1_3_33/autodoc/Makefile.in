#
# makefile for generating documentation from the Caudium sources
#
# $Id$
#

PIKE=@PIKE_BIN@
HACKS=base_server/caudium.pike

all: crefhtml

crefhtml: do_hacks make_crefhtml undo_hacks

do_hacks:
	@for h in $(HACKS); do \
		cp -p ../server/$$h ../server/$$h.orig ; \
		sed -e 's#@PIKEPARSER_HACK_START@\*/# #g' -e 's#/\*@PIKEPARSER_HACK_END@# #g' < ../server/$$h.orig > ../server/$$h ; \
	done

undo_hacks:
	@for h in $(HACKS); do \
		mv ../server/$$h.orig ../server/$$h ; \
	done

make_crefhtml: makecrefdirs makecrefxml
	rm -rf generated/caudiumref || /bin/true
	mkdir -p generated/caudiumref
	cp -p structure/caudiumref.css generated/caudiumref/style.css
	cp -pr structure/images/ generated/caudiumref/
	$(PIKE) bin/tree-split-autodoc.pike build/cref.xml structure/caudiumref.html generated/caudiumref/

makecrefxml: makeautodoc structure/caudiumref.xml
	$(PIKE) -x assemble_autodoc structure/caudiumref.xml build/autodoc.xml > build/cref.xml

makeautodoc: makeserver makeetc
	$(PIKE) -x join_autodoc --post-process build/autodoc.xml build/server.xml build/etc.xml

makeserver:
	$(PIKE) -x extract_autodoc ../server/base_server/ src_images/ build/server/ build/images/
	$(PIKE) -x join_autodoc build/server.xml build/server/

makeetc:
	$(PIKE) -x extract_autodoc ../server/etc/ src_images/ build/etc/ build/images/
	$(PIKE) -x join_autodoc build/etc.xml build/etc/

makecrefdirs:
	@install -d -m 755 build/server/
	@install -d -m 755 build/etc/

spotless:
	@for f in `cat .cvsignore`; do \
		rm -rf $$f; \
	done
	@for f in `cat bin/.deleteus`; do \
		rm -f bin/$$f; \
	done
	@rm -f bin/.deleteus
	@rm -rf build/server/
	@rm -rf build/etc/
	@rm -rf build/*.xml
	@rm -rf generated/caudiumref
